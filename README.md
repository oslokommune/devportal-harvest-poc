# devportal-harvest-poc

Data flow diagram: https://docs.google.com/drawings/d/1Kdmk0tvVnVhk0weMl3SULSFyyQnd77SwSwZIiTAIQhM/edit

## Setup
1. `git clone git@github.com:oslokommune/devportal-harvest-poc.git`
2. `make init`
3. `source .venv/bin/activate`

## Preparation
1. kubectl apply -f charts/harvest-output-pvc. This is the PVC where all the
	 harvesters will pipe their output to and where the latest_provider and distributors will read from
2. Create and configure a [sources.yaml](https://github.com/oslokommune/devportal-harvest-poc/blob/master/docs/sources_template.yaml) file
3. Create and configure a [distributors.yaml](https://github.com/oslokommune/devportal-harvest-poc/blob/master/docs/distributors_template.yaml) file

## Deployment
### Deploy harvesters
1. `make build`
2. `cat sources.yaml | python harvest.py`

### Deploy distributor
1. `cat distributors.yaml | python distribute.py`

### Deploy latest_provider
1. `cd tools/latest_provider`
2. `make deploy-test`

## Running locally
1. `make create-dotenv-file` and configure the variables needed for the
	 harvester or distributor you want to run
2. `export $(cat .env)`
3. `pip install <path to relevant requirements.txt>`
4. `python relevant_script.py`

For example, if running the AWS harvester:
1. Configure the variables prefixed with AWS_ in .env file
2. `export $(cat .env)`
3. `pip install harvester/aws/requirements.txt`
4. `python harvester/aws/aws.py`

## Concepts
### Harvester
A harvester is a self contained service which based on an environment will print
out all the APIs associated with the configured environment.

### Distributor
A distributor is a self contained service which based on an environment will
expose the data generated by the harvester(s) somehow

## Stack
Based on a [sources.yaml](https://github.com/oslokommune/devportal-harvest-poc/blob/master/docs/sources_template.yaml)
file, the harvest.py script will generate cronjobs that will pipe their output
to a persistent volume.

The latest_provider service will upon a GET request to /apis expose the sum of all the
.json files in the mentioned persistent volume claim.

The harvester frontend does a GET /apis to the latest_provider service and presents
the result.

## [Roadmap](https://github.com/oslokommune/devportal-harvest-poc/projects/1?add_cards_query=is%3Aopen)
